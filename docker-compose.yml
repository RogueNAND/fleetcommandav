services:

  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    init: true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
      - "8443:8443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.codeserver.address=:8443"
      # - "--api.dashboard=true"
      # - "--api.insecure=true" # only on trusted LAN
    mem_limit: 256m
    cpu_shares: 256
    logging:
      driver: journald
      options:
        tag: "traefik"

  companion:
    image: "ghcr.io/roguenand/companion:v4.2.2"
    container_name: companion
    restart: unless-stopped
    network_mode: host
    init: true
    user: "1000:1000"
    volumes:
      - ./compose/companion:/companion
      - ./companion/libraries:/app/module-local-dev
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/ || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
    mem_limit: 1500m
    cpu_shares: 2048  # highest priority
    logging:
      driver: journald
      options:
        tag: "companion"

  ontime:
    image: getontime/ontime:latest
    profiles:
      - all
      - ontime
    container_name: ontime
    restart: unless-stopped
    init: true
    ports:
      - "4001:4001/tcp"
      - "8888:8888/udp"
      - "9999:9999/udp"
    volumes:
      - "./compose/ontime:/data/"
    environment:
      - TZ=US/Eastern
    mem_limit: 256m
    cpu_shares: 256
    logging:
      driver: journald
      options:
        tag: "ontime"

  homeassistant:
    container_name: homeassistant
    image: "ghcr.io/home-assistant/home-assistant:stable"
    profiles:
      - all
      - ha
    restart: unless-stopped
    ports:
      - "8123:8123"
    volumes:
      - ./compose/homeassistant:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
    privileged: true
    mem_limit: 1024m
    cpu_shares: 512
    logging:
      driver: journald
      options:
        tag: "homeassistant"

  python:
    build: ./framework
    container_name: python
    restart: unless-stopped
    network_mode: host
    init: true
    volumes:
      - ./framework:/fleetcommand
      - ./modules:/modules
      - ./compose/editor/settings/snippets:/snippets
      - ./compose/public/files:/public
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/fleetcommand:/modules
    mem_limit: 1024m
    cpu_shares: 1536  # second priority after companion
    logging:
      driver: journald
      options:
        tag: "python"

  code-server:
    image: linuxserver/code-server
    container_name: editor
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - .:/config/workspace:rw
      - ./compose/editor/settings:/config/data/User/
      - ./compose/editor/settings/snippets:/config/data/User/snippets
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.codeserver.rule=PathPrefix(`/`)"
      - "traefik.http.routers.codeserver.entrypoints=codeserver"
      - "traefik.http.routers.codeserver.priority=10"
      - "traefik.http.routers.codeserver.middlewares=simple-auth"
      - "traefik.http.services.codeserver.loadbalancer.server.port=8443"
      - "traefik.http.middlewares.simple-auth.basicauth.users=${ADMIN_USER}:${ADMIN_PASS}"
    mem_limit: 512m
    cpu_shares: 256
    logging:
      driver: journald
      options:
        tag: "code-server"

  homer:
    image: b4bz/homer:latest
    container_name: dashboard
    restart: unless-stopped
    init: true
    volumes:
      - ./compose/dashboard:/www/assets
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homer.rule=PathPrefix(`/`)"
      - "traefik.http.routers.homer.entrypoints=web"
      - "traefik.http.routers.homer.priority=1"
      - "traefik.http.services.homer.loadbalancer.server.port=8080"
    mem_limit: 64m
    cpu_shares: 128
    logging:
      driver: journald
      options:
        tag: "homer"

  grist:
    image: gristlabs/grist
    profiles:
      - all
      - sheets
    container_name: grist
    restart: unless-stopped
    init: true
    ports:
      - "8484:8484"
    volumes:
      - ./compose/grist:/persist
    mem_limit: 1024m
    cpu_shares: 256
    logging:
      driver: journald
      options:
        tag: "grist"

  dozzle:
    image: amir20/dozzle:latest
    container_name: log-viewer
    restart: unless-stopped
    init: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DOZZLE_BASE: /logs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dozzle.rule=PathPrefix(`/logs`)"
      - "traefik.http.routers.dozzle.entrypoints=web"
      - "traefik.http.routers.dozzle.priority=10"
      - "traefik.http.services.dozzle.loadbalancer.server.port=8080"
      - "traefik.http.routers.dozzle.middlewares=simple-auth"
      - "traefik.http.middlewares.simple-auth.basicauth.users=${ADMIN_USER}:${ADMIN_PASS}"
    mem_limit: 256m
    cpu_shares: 128
    logging:
      driver: journald
      options:
        tag: "dozzle"

  contentshare:
    image: tanq16/local-content-share:main
    profiles:
      - all
      - share
    container_name: local-content-share
    restart: unless-stopped
    init: true
    ports:
      - "8090:8080"
    volumes:
      - ./compose/contentshare:/app/data
    mem_limit: 256m
    cpu_shares: 128
    logging:
      driver: journald
      options:
        tag: "contentshare"

  public_http:
    image: nginx:alpine
    profiles:
      - all
      - public
    container_name: public
    restart: unless-stopped
    init: true
    volumes:
      - ./compose/public/files:/usr/share/nginx/html:ro
      - ./compose/public/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.public.rule=PathPrefix(`/public`)"
      - "traefik.http.routers.public.entrypoints=web"
      - "traefik.http.services.public.loadbalancer.server.port=80"
    mem_limit: 256m
    cpu_shares: 256
    logging:
      driver: journald
      options:
        tag: "public_http"
